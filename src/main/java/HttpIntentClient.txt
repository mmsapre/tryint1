package com.example.semantic.intent;

import com.example.semantic.model.IntentResult;
import com.example.semantic.model.RequestFacts;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.util.Map;

@Component
public class HttpIntentClient implements IntentService {

  private final WebClient client;
  private final String classifyPath;

  public HttpIntentClient(
      @Value("${intent.baseUrl}") String baseUrl,
      @Value("${intent.classifyPath}") String classifyPath
  ) {
    this.client = WebClient.builder().baseUrl(baseUrl).build();
    this.classifyPath = classifyPath;
  }

  @Override
  public Mono<IntentResult> classify(RequestFacts facts) {
    // Permit-style: you send prompt (if available) + request summary.
    String prompt = facts.promptHint();
    if (prompt == null || prompt.isBlank()) {
      prompt = facts.method() + " " + facts.path();
    }
    Map<String, Object> payload = Map.of(
        "text", prompt,
        "method", facts.method(),
        "path", facts.path(),
        "body", facts.requestBody()
    );
    return client.post()
        .uri(classifyPath)
        .bodyValue(payload)
        .retrieve()
        .bodyToMono(IntentResult.class);
  }
}
